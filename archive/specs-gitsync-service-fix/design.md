# Документ дизайна - Исправление службы GitSync

## Обзор

Данный дизайн описывает решение критической проблемы с службой GitSync, которая не запускается из-за ошибки с кодом 5 (отказано в доступе). Решение включает диагностику проблемы, исправление конфигурации службы, настройку правильных прав доступа и создание надежного механизма мониторинга.

## Архитектура

### Текущая проблемная архитектура
```
Windows Service (GitSync-Service) [STOPPED - Error 5]
    ↓ (не работает)
PowerShell Script (gitsync-service-working.ps1)
    ↓ (не выполняется)
GitSync Tool → 1C Repository → Git Repository
```

### Целевая архитектура
```
Windows Scheduled Task (GitSync-Sync) [RUNNING]
    ↓ (каждые 10 минут)
PowerShell Script (gitsync-service-working.ps1) [с правильными правами]
    ↓ (выполняется успешно)
GitSync Tool → 1C Repository → Git Repository → GitLab CI/CD
    ↓ (логирование)
Centralized Logging System
```

## Компоненты и интерфейсы

### 1. Диагностический компонент
**Назначение**: Определение причины ошибки службы и состояния системы

**Интерфейсы**:
- Проверка статуса Windows Service
- Анализ логов службы
- Проверка прав доступа к файлам и каталогам
- Тестирование подключения к хранилищу 1С
- Проверка доступности GitLab

**Выходные данные**:
- Отчет о диагностике с выявленными проблемами
- Рекомендации по исправлению

### 2. Компонент исправления службы
**Назначение**: Исправление конфигурации и прав доступа службы

**Интерфейсы**:
- Удаление проблемной Windows Service
- Создание новой Scheduled Task
- Настройка правильных прав доступа
- Конфигурирование переменных окружения

**Входные данные**:
- Результаты диагностики
- Параметры конфигурации службы

**Выходные данные**:
- Работающая задача планировщика
- Обновленные права доступа

### 3. Компонент синхронизации
**Назначение**: Выполнение синхронизации между хранилищем 1С и Git

**Интерфейсы**:
- Подключение к хранилищу конфигурации 1С
- Извлечение изменений из хранилища
- Распаковка обычных форм
- Создание Git коммитов
- Отправка изменений в GitLab

**Входные данные**:
- Параметры подключения к хранилищу 1С
- Настройки Git репозитория
- Флаги синхронизации (-R -F -P -G -l 5)

**Выходные данные**:
- Синхронизированные изменения в Git
- Логи операций синхронизации

### 4. Компонент мониторинга и логирования
**Назначение**: Отслеживание состояния службы и логирование операций

**Интерфейсы**:
- Запись логов операций синхронизации
- Мониторинг статуса задачи планировщика
- Отправка алертов при ошибках
- Ротация лог-файлов

**Входные данные**:
- События синхронизации
- Ошибки и исключения
- Статус системных компонентов

**Выходные данные**:
- Структурированные лог-файлы
- Алерты и уведомления
- Метрики производительности

## Модели данных

### Конфигурация службы
```json
{
  "serviceName": "GitSync-Sync",
  "taskType": "ScheduledTask",
  "interval": "10 minutes",
  "scriptPath": "ci\\scripts\\gitsync-service-working.ps1",
  "workingDirectory": "C:\\1C-CI-CD",
  "runAsUser": "SYSTEM",
  "environmentVariables": {
    "GITSYNC_STORAGE_PATH": "file://C:/1crepository",
    "GITSYNC_STORAGE_USER": "gitsync",
    "GITSYNC_STORAGE_PASSWORD": "123",
    "GITSYNC_V8_PATH": "C:/Program Files/1cv8/8.3.12.1714/bin/1cv8.exe",
    "GITSYNC_WORKDIR": "C:\\1C-CI-CD"
  }
}
```

### Лог-запись синхронизации
```json
{
  "timestamp": "2025-10-21T10:30:00Z",
  "level": "INFO|WARN|ERROR",
  "component": "GitSync",
  "operation": "sync|extract|commit|push",
  "message": "Описание операции",
  "details": {
    "changesCount": 5,
    "filesProcessed": 12,
    "duration": "00:02:15",
    "gitCommitHash": "abc123def456"
  },
  "error": {
    "code": "ERROR_CODE",
    "message": "Сообщение об ошибке",
    "stackTrace": "Трассировка стека"
  }
}
```

### Статус диагностики
```json
{
  "timestamp": "2025-10-21T10:00:00Z",
  "systemStatus": "OK|WARNING|ERROR",
  "components": {
    "windowsService": {
      "status": "STOPPED",
      "error": "Error code 5: Access denied",
      "recommendation": "Recreate as Scheduled Task"
    },
    "scheduledTask": {
      "status": "NOT_EXISTS",
      "recommendation": "Create new task"
    },
    "gitSync": {
      "status": "INSTALLED",
      "version": "3.6.1"
    },
    "repository1C": {
      "status": "ACCESSIBLE",
      "path": "file://C:/1crepository"
    },
    "gitLab": {
      "status": "ACCESSIBLE",
      "url": "http://localhost:8929"
    }
  }
}
```

## Обработка ошибок

### Стратегия обработки ошибок
1. **Ошибки подключения к хранилищу 1С**:
   - Повторная попытка через 5 минут
   - Максимум 3 попытки
   - Логирование ошибки и уведомление администратора

2. **Ошибки Git операций**:
   - Проверка состояния репозитория
   - Автоматическое разрешение простых конфликтов
   - Откат к последнему рабочему состоянию при критических ошибках

3. **Ошибки прав доступа**:
   - Проверка прав доступа к файлам и каталогам
   - Автоматическое исправление прав (если возможно)
   - Уведомление администратора о необходимости ручного вмешательства

4. **Ошибки сети**:
   - Проверка доступности GitLab
   - Кэширование изменений для отправки при восстановлении связи
   - Уведомление о проблемах с сетью

### Механизм восстановления
- Автоматический перезапуск задачи при сбое
- Сохранение состояния синхронизации
- Возможность ручного запуска синхронизации
- Откат к предыдущей рабочей конфигурации

## Стратегия тестирования

### Модульное тестирование
- Тестирование функций диагностики
- Тестирование компонентов синхронизации
- Тестирование обработки ошибок
- Тестирование логирования

### Интеграционное тестирование
- Тестирование подключения к хранилищу 1С
- Тестирование интеграции с GitLab
- Тестирование полного цикла синхронизации
- Тестирование мониторинга и алертов

### Системное тестирование
- Тестирование автоматического запуска службы
- Тестирование работы в различных сценариях нагрузки
- Тестирование восстановления после сбоев
- Тестирование безопасности и прав доступа

### Приемочное тестирование
- Проверка соответствия всем требованиям
- Тестирование пользовательских сценариев
- Проверка производительности
- Валидация логирования и мониторинга

## План реализации

### Фаза 1: Диагностика и анализ (1-2 дня)
1. Создание скрипта диагностики системы
2. Анализ текущего состояния службы
3. Выявление всех проблем и их причин
4. Подготовка плана исправления

### Фаза 2: Исправление службы (2-3 дня)
1. Удаление проблемной Windows Service
2. Создание новой Scheduled Task
3. Настройка правильных прав доступа
4. Конфигурирование переменных окружения
5. Тестирование базовой функциональности

### Фаза 3: Улучшение мониторинга (1-2 дня)
1. Улучшение системы логирования
2. Создание алертов и уведомлений
3. Интеграция с централизованным мониторингом
4. Настройка ротации логов

### Фаза 4: Тестирование и валидация (1-2 дня)
1. Комплексное тестирование всех сценариев
2. Проверка автоматического запуска
3. Тестирование обработки ошибок
4. Валидация производительности

### Фаза 5: Документация и передача (1 день)
1. Обновление документации
2. Создание руководства по эксплуатации
3. Обучение администраторов
4. Передача в эксплуатацию

## Риски и митигация

### Технические риски
1. **Проблемы с правами доступа**:
   - Митигация: Тщательное тестирование прав доступа
   - План Б: Использование специальной учетной записи службы

2. **Конфликты в Git репозитории**:
   - Митигация: Реализация автоматического разрешения конфликтов
   - План Б: Ручное разрешение конфликтов администратором

3. **Нестабильность подключения к хранилищу 1С**:
   - Митигация: Реализация механизма повторных попыток
   - План Б: Кэширование изменений для последующей синхронизации

### Операционные риски
1. **Простой системы во время исправления**:
   - Митигация: Выполнение работ в нерабочее время
   - План Б: Быстрый откат к предыдущей конфигурации

2. **Потеря данных синхронизации**:
   - Митигация: Создание резервной копии перед изменениями
   - План Б: Восстановление из резервной копии

## Метрики успеха

### Функциональные метрики
- Служба запускается автоматически: 100%
- Синхронизация выполняется каждые 10 минут: 100%
- Успешность синхронизации: > 95%
- Время восстановления после сбоя: < 10 минут

### Производительные метрики
- Время выполнения синхронизации: < 5 минут
- Использование CPU: < 10%
- Использование памяти: < 500 MB
- Размер лог-файлов: < 100 MB в день

### Качественные метрики
- Количество ошибок в день: < 5
- Время диагностики проблем: < 30 минут
- Удовлетворенность пользователей: > 90%
- Доступность системы: > 99%
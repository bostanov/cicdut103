# План задач - Восстановление и доработка CI/CD системы для 1С

## Обзор

Данный план содержит детальные задачи для восстановления работоспособности CI/CD системы для 1С и реализации недостающей функциональности. План разделен на 4 этапа с четкими приоритетами.

## Этап 1: Восстановление инфраструктуры

### 1.1 Создание нового базового образа Docker

- [ ] 1.1.1 Исследовать совместимость платформы 1С 8.3.12.1714 с различными версиями Ubuntu
  - Проверить документацию 1С по системным требованиям
  - Определить оптимальную версию Ubuntu (16.04, 18.04 или 20.04)
  - Документировать принятое решение в INFRASTRUCTURE.md
  - _Требования: 5.1_

- [ ] 1.1.2 Создать новый Dockerfile для CI/CD контейнера
  - Использовать выбранную версию Ubuntu как базовый образ
  - Установить необходимые зависимости для OneScript, GitSync, PreCommit1C
  - Подготовить окружение для установки платформы 1С
  - Сохранить старый Dockerfile как Dockerfile.backup
  - _Требования: 5.1_

- [ ] 1.1.3 Установить платформу 1С 8.3.12.1714 в новый образ
  - Скопировать дистрибутив из C:\install\client_8_3_12_1714.deb64.tar.gz
  - Выполнить установку платформы в контейнер
  - Проверить корректность установки (запуск 1cv8c --version)
  - Документировать процесс установки в INFRASTRUCTURE.md
  - _Требования: 5.1, 5.2_

- [ ] 1.1.4 Протестировать новый образ
  - Собрать новый образ Docker
  - Проверить доступность платформы 1С
  - Проверить работу OneScript и GitSync
  - Зафиксировать изменения в Git репозитории
  - _Требования: 5.1_

### 1.2 Исправление Health Check

- [ ] 1.2.1 Исправить ошибки импорта в health_check.py
  - Изменить относительные импорты на абсолютные
  - Исправить строку: `from .logger import get_logger` → `from shared.logger import get_logger`
  - Протестировать запуск health_check.py отдельно
  - _Требования: системная стабильность_

- [ ] 1.2.2 Обновить конфигурацию supervisord для health-check
  - Проверить правильность путей в supervisord.conf
  - Убедиться в корректности переменных окружения PYTHONPATH
  - Протестировать запуск через supervisord
  - _Требования: системная стабильность_

### 1.3 Исправление конфигурации GitSync Service

- [ ] 1.3.1 Исправить логику обновления конфигурации GitSync
  - Изменить метод `_update_gitsync_config()` в gitsync_service.py
  - Использовать правильный путь к платформе: `/opt/1C/v8.3/x86_64/1cv8c`
  - Использовать правильные учетные данные: gitsync/123
  - Использовать правильный путь к хранилищу: `file:///1c-storage`
  - _Требования: 5.2, 5.3, 5.4_

- [ ] 1.3.2 Обновить переменные окружения в docker-compose
  - Установить GITSYNC_STORAGE_USER=gitsync
  - Установить GITSYNC_STORAGE_PASSWORD=123
  - Проверить правильность монтирования хранилища
  - _Требования: 5.2_

- [ ] 1.3.3 Протестировать GitSync с реальным хранилищем
  - Запустить GitSync Service с исправленной конфигурацией
  - Проверить успешную синхронизацию с хранилищем C:\1crepository
  - Убедиться в отсутствии ошибок в логах
  - Документировать результаты тестирования
  - _Требования: 5.1, 5.4_

## Этап 2: Восстановление интеграций

### 2.1 Исправление системы инициализации

- [x] 2.1.1 Отладить создание проектов GitLab ✅
  - Проверить доступность GitLab API ✅
  - Отладить метод `initialize_gitlab()` in init_integrations.py ✅
  - Убедиться в создании проектов ut103-ci и ut103-external-files ✅
  - Проверить создание токенов и настройку переменных окружения ✅
  - _Требования: 6.1, 6.2_
  - **Выполнено**: Проекты созданы, токен YOUR_GITLAB_TOKEN_HERE

- [x] 2.1.2 Отладить создание проектов SonarQube ✅
  - Проверить доступность SonarQube API ✅
  - Отладить метод `initialize_sonarqube()` in init_integrations.py ✅
  - Убедиться в создании проектов ut103-ci и ut103-external-files ✅
  - Настроить Quality Gates для 1С проектов ✅
  - _Требования: анализ качества кода_
  - **Выполнено**: Проекты созданы, токен squ_9f27d25fa1bf6c3709ea1b2ae790fd53df67fc16

- [x] 2.1.3 Проверить создание проекта Redmine ✅
  - Убедиться в корректности создания проекта ut103-ci ✅
  - Проверить создание трекеров и пользовательских полей ✅
  - Создать пользователей для интеграции ✅
  - _Требования: 1.1, 2.1_
  - **Выполнено**: Проект создан, API key 3bd281756c90fae4a2b5c8d9e0f1a2b3c4d5e6f7

### 2.2 Создание пайплайнов CI/CD

- [x] 2.2.1 Создать .gitlab-ci.yml для основного проекта (ut103-ci) ✅
  - Настроить стадии: build, test, sonarqube-check ✅
  - Интегрировать с SonarQube для анализа кода 1С ✅
  - Настроить переменные окружения для интеграции ✅
  - Протестировать пайплайн на тестовых данных ⏳
  - _Требования: 1.3, 6.5_
  - **Выполнено**: Пайплайн создан в templates/.gitlab-ci-main.yml

- [x] 2.2.2 Создать .gitlab-ci.yml для внешних файлов (ut103-external-files) ✅
  - Настроить стадии для анализа внешних файлов .epf/.erf/.efd ✅
  - Интегрировать с SonarQube для анализа разобранного кода ✅
  - Настроить уведомления в Redmine ✅
  - _Требования: 2.3, 2.4, 6.5_
  - **Выполнено**: Пайплайн создан в templates/.gitlab-ci-external.yml

### 2.3 Настройка интеграции между сервисами

- [x] 2.3.1 Настроить Pipeline Coordinator для GitSync ✅
  - Проверить метод `trigger_gitsync_pipeline()` ⏳
  - Убедиться в корректной интеграции с GitLab API ✅
  - Настроить получение результатов из SonarQube ✅
  - Протестировать создание уведомлений в Redmine ⏳
  - _Требования: 1.3, 1.4, 1.5_
  - **Статус**: Переменные настроены, требуется тестирование

- [x] 2.3.2 Настроить Pipeline Coordinator для PreCommit1C ✅
  - Проверить метод `trigger_precommit_pipeline()` ⏳
  - Убедиться в корректной обработке внешних файлов ⏳
  - Настроить создание веток в GitLab ✅
  - Протестировать уведомления в задачах Redmine ⏳
  - _Требования: 2.3, 2.4, 2.5_
  - **Статус**: Переменные настроены, требуется тестирование

## Этап 3: Тестирование с реальными данными

### 3.1 Подготовка тестовых данных

- [ ] 3.1.1 Создать механизм добавления данных в хранилище 1С
  - Создать скрипт для добавления тестовых версий в хранилище
  - Предоставить инструкции для ручного добавления данных
  - Создать примеры коммитов с номерами задач в формате [#номер]
  - Документировать процесс в TESTING.md
  - _Требования: 5.4_

- [ ] 3.1.2 Создать тестовые задачи в Redmine
  - Создать задачу на доработку конфигурации с номером для тестирования GitSync
  - Создать задачу на разработку внешнего отчета для тестирования PreCommit1C
  - Подготовить тестовые файлы .epf/.erf для прикрепления
  - _Требования: 1.1, 2.1_

### 3.2 Тестирование полного цикла GitSync

- [ ] 3.2.1 Протестировать цикл: Хранилище 1С → GitSync → GitLab
  - Добавить изменения в хранилище 1С с номером задачи
  - Проверить синхронизацию GitSync с GitLab
  - Убедиться в создании коммита в проекте ut103-ci
  - _Требования: 1.2, 5.4_

- [ ] 3.2.2 Протестировать цикл: GitLab → SonarQube → Redmine
  - Проверить автоматический запуск пайплайна в GitLab
  - Убедиться в выполнении анализа в SonarQube
  - Проверить создание уведомления в задаче Redmine
  - _Требования: 1.3, 1.4, 1.5_

### 3.3 Тестирование полного цикла PreCommit1C

- [ ] 3.3.1 Протестировать цикл: Redmine → PreCommit1C → GitLab
  - Прикрепить тестовый файл .epf к задаче в Redmine
  - Проверить автоматическое обнаружение и скачивание файла
  - Убедиться в разборе файла и создании ветки в GitLab
  - _Требования: 2.2, 2.3_

- [ ] 3.3.2 Протестировать цикл: GitLab → SonarQube → Redmine
  - Проверить запуск пайплайна для внешнего файла
  - Убедиться в анализе разобранного кода в SonarQube
  - Проверить добавление комментария с результатами в задачу
  - _Требования: 2.4, 2.5_

## Этап 4: Реализация недостающей функциональности

### 4.1 Система статусов задач

- [ ] 4.1.1 Создать кастомные статусы в Redmine
  - Добавить статус "На проверке" для задач в процессе анализа
  - Добавить статус "Проверка пройдена" для успешно проанализированных задач
  - Добавить статус "Есть замечания" для задач с проблемами качества
  - Настроить workflow переходов между статусами
  - _Требования: 3.1, 3.2, 3.3_

- [ ] 4.1.2 Реализовать автоматическое обновление статусов
  - Модифицировать Pipeline Coordinator для изменения статусов задач
  - Добавить логику определения статуса на основе результатов SonarQube
  - Реализовать обновление статуса при запуске анализа ("На проверке")
  - Реализовать обновление статуса при завершении анализа
  - _Требования: 3.4, 3.5_

### 4.2 Контроль версий и дублирования внешних файлов

- [ ] 4.2.1 Реализовать проверку дублирования файлов
  - Добавить в PreCommit1C Service проверку имен файлов между задачами
  - Создать механизм поиска файлов с аналогичными именами
  - Реализовать создание предупреждений в задачах о дублировании
  - _Требования: 7.1, 7.2_

- [ ] 4.2.2 Реализовать систему версионирования внешних файлов
  - Добавить автоматическое определение версий файлов
  - Реализовать сохранение истории изменений файлов
  - Создать уведомления авторов связанных задач о новых версиях
  - _Требования: 7.3, 7.4, 7.5_

### 4.3 Улучшение системы уведомлений

- [ ] 4.3.1 Реализовать внутренние уведомления Redmine
  - Настроить отправку уведомлений при изменении статуса задач
  - Добавить уведомления участникам проекта о новых коммитах
  - Реализовать настройку уведомлений по ролям пользователей
  - _Требования: 4.1, 4.3_

- [ ] 4.3.2 Улучшить содержание уведомлений
  - Добавить более детальную информацию о проблемах качества кода
  - Включить рекомендации по исправлению найденных проблем
  - Добавить ссылки на документацию и стандарты кодирования
  - _Требования: 4.4, 4.5_

### 4.4 Система ролей и доступа

- [ ] 4.4.1 Реализовать единую систему ролей
  - Создать роль "Пользователь" с ограниченными правами
  - Создать роль "Администратор" с полными правами
  - Настроить ограничения доступа в каждом сервисе
  - _Требования: 8.1, 8.2, 8.3, 8.4_

## Общие требования к выполнению задач

### Документирование

- [ ] Вести документацию всех принятых решений в соответствующих .md файлах
- [ ] Создать INFRASTRUCTURE.md для документирования изменений инфраструктуры
- [ ] Создать TESTING.md для документирования процедур тестирования
- [ ] Обновлять CHANGELOG.md при каждом значимом изменении

### Управление временными файлами

- [ ] Очищать временные файлы после каждой задачи
- [ ] Использовать .gitignore для исключения временных файлов из репозитория
- [ ] Документировать расположение временных файлов в каждом компоненте

### Контроль версий

- [ ] Фиксировать изменения в Git репозитории после каждой завершенной задачи
- [ ] Использовать осмысленные сообщения коммитов с указанием номера задачи
- [ ] Создавать отдельные ветки для крупных изменений (смена базового образа)
- [ ] Регулярно синхронизировать с GitHub репозиторием проекта

### Тестирование

- [ ] Тестировать каждый компонент после внесения изменений
- [ ] Проводить интеграционное тестирование после завершения этапа
- [ ] Документировать результаты тестирования
- [ ] Создавать автоматические тесты для критически важной функциональности

## Критерии готовности

### Этап 1 завершен, когда:
- ✅ GitSync Service работает без ошибок с реальным хранилищем 1С
- ✅ Health Check запускается без ошибок
- ✅ Платформа 1С корректно установлена и доступна
- ✅ Все изменения зафиксированы в Git

### Этап 2 завершен, когда:
- ✅ Проекты созданы в GitLab и SonarQube
- ✅ Пайплайны CI/CD работают корректно
- ✅ Pipeline Coordinator успешно координирует процессы
- ✅ Интеграция между сервисами функционирует

### Этап 3 завершен, когда:
- ✅ Полный цикл GitSync работает с реальными данными
- ✅ Полный цикл PreCommit1C работает с тестовыми файлами
- ✅ Все уведомления создаются корректно
- ✅ Система готова к промышленному использованию

### Этап 4 завершен, когда:
- ✅ Все 8 требований из спецификации полностью реализованы
- ✅ Система статусов задач работает автоматически
- ✅ Контроль версий внешних файлов функционирует
- ✅ Расширенные уведомления и роли настроены

# Руководство по тестированию CI/CD системы

**Автор**: Бостанов Ф.А.  
**Версия**: 1.0  
**Дата**: 6 ноября 2025

---

## Оглавление

1. [Первоначальное заполнение систем](#первоначальное-заполнение-систем)
2. [Автоматизированное тестирование](#автоматизированное-тестирование)
3. [Ручное тестирование](#ручное-тестирование)
4. [Чеклисты проверки](#чеклисты-проверки)
5. [Решение проблем](#решение-проблем)

---

## Первоначальное заполнение систем

### Этап 1: Подготовка окружения

#### 1.1. Запуск сервисов

```powershell
# Запуск Docker контейнеров
docker-compose -f docker-compose-full-stack.yml up -d

# Проверка статуса
docker ps

# Проверка логов
docker logs -f gitlab
docker logs -f redmine
docker logs -f sonarqube
```

**Ожидаемый результат**:
- ✅ Все контейнеры в статусе `healthy` или `running`
- ✅ GitLab доступен на http://localhost:8929
- ✅ Redmine доступен на http://localhost:3000
- ✅ SonarQube доступен на http://localhost:9000

#### 1.2. Получение токенов доступа

**GitLab**:
1. Откройте http://localhost:8929
2. Войдите как `root` / `gitlab_root_password`
3. User Settings → Access Tokens
4. Создайте токен с правами: `api`, `read_repository`, `write_repository`
5. Сохраните токен в файл `secrets/gitlab_token.txt`

**Redmine**:
1. Откройте http://localhost:3000
2. Войдите как `admin` / `admin`
3. My account → API access key → Show
4. Сохраните ключ в файл `secrets/redmine_api_key.txt`

**SonarQube**:
1. Откройте http://localhost:9000
2. Войдите как `admin` / `admin`
3. Смените пароль (обязательно при первом входе)
4. My Account → Security → Generate Token
5. Сохраните токен в файл `secrets/sonarqube_token.txt`

#### 1.3. Создание файла .env

```powershell
# Создание .env с параметрами
python scripts/setup/load-seed-data.py
```

**Заполните токены в `.env`**:
```env
GITLAB_TOKEN=<токен из secrets/gitlab_token.txt>
REDMINE_API_KEY=<ключ из secrets/redmine_api_key.txt>
SONARQUBE_TOKEN=<токен из secrets/sonarqube_token.txt>
```

### Этап 2: Инициализация проектов

#### 2.1. Создание проектов в сервисах

```powershell
# Загрузка переменных окружения
Get-Content .env | ForEach-Object {
    if ($_ -match '^([^=]+)=(.*)$') {
        [Environment]::SetEnvironmentVariable($matches[1], $matches[2])
    }
}

# Создание проектов
python scripts/setup/init-projects.py
```

**Ожидаемый результат**:
```
✅ GitLab: Проект создан (ID: 1)
   URL: http://localhost:8929/root/ut-103-ci-cd
✅ Redmine: Проект создан (ID: 1)
   URL: http://localhost:3000/projects/ut103-ci
✅ SonarQube: Проект создан (Key: ut103-ci)
   URL: http://localhost:9000/dashboard?id=ut103-ci
```

#### 2.2. Загрузка эталонных данных

```powershell
# Загрузка пользователей и справочников
python scripts/setup/load-seed-data.py
```

**Ожидаемый результат**:
- ✅ Созданы пользователи: `admin`, `developer`, `tester`, `analyst`
- ✅ Настроены роли и права доступа
- ✅ Созданы трекеры задач в Redmine
- ✅ Проверены контрольные суммы данных

#### 2.3. Настройка GitLab Runner

```powershell
# Получение registration token из GitLab UI
# http://localhost:8929/admin/runners → New instance runner

# Запуск скрипта настройки
.\scripts\setup\init-runner.ps1 -RunnerToken "YOUR_TOKEN_HERE"
```

**Ожидаемый результат**:
```
✅ GitLab Runner настроен и запущен
   Имя:        1c-cicd-runner
   URL:        http://localhost:8929
   Теги:       1c-tests, sonar, deploy
   Executor:   docker
```

### Этап 3: Проверка интеграций

#### 3.1. Проверка webhooks

**GitLab → Redmine**:
1. Откройте GitLab: http://localhost:8929/root/ut-103-ci-cd/-/hooks
2. Проверьте webhook: `http://redmine:3000/gitlab_webhook`
3. Нажмите "Test" → "Push events"
4. Проверьте Redmine логи: `docker logs redmine`

**SonarQube → GitLab**:
1. Откройте SonarQube: http://localhost:9000/project/webhooks?id=ut103-ci
2. Проверьте webhook: `http://gitlab/api/v4/projects/1/statuses/{SHA}`

#### 3.2. Проверка доступов

```powershell
# Тест доступа к GitLab API
$gitlabToken = Get-Content secrets/gitlab_token.txt
Invoke-RestMethod -Uri "http://localhost:8929/api/v4/projects" -Headers @{"PRIVATE-TOKEN"=$gitlabToken}

# Тест доступа к Redmine API
$redmineKey = Get-Content secrets/redmine_api_key.txt
Invoke-RestMethod -Uri "http://localhost:3000/projects.json" -Headers @{"X-Redmine-API-Key"=$redmineKey}

# Тест доступа к SonarQube API
$sonarToken = Get-Content secrets/sonarqube_token.txt
Invoke-RestMethod -Uri "http://localhost:9000/api/projects/search" -Headers @{"Authorization"="Bearer $sonarToken"}
```

---

## Автоматизированное тестирование

### Запуск полного цикла тестов

```powershell
.\scripts\testing\run-automated-tests.ps1
```

### Выборочный запуск

```powershell
# Только PreCommit1C
.\scripts\testing\run-automated-tests.ps1 -SkipUnitTests -SkipSonar -SkipFunctional

# Только SonarQube
.\scripts\testing\run-automated-tests.ps1 -SkipPrecommit -SkipUnitTests -SkipFunctional

# Без функциональных тестов
.\scripts\testing\run-automated-tests.ps1 -SkipFunctional
```

### Интерпретация результатов

**Успешное выполнение**:
```
ИТОГОВЫЙ ОТЧЕТ
================================================
Всего тестов:     15
Успешно:          15
Провалено:        0
Процент успеха:   100%

✅ ВСЕ ТЕСТЫ УСПЕШНО ПРОЙДЕНЫ!
```

**Частичный успех**:
```
ИТОГОВЫЙ ОТЧЕТ
================================================
Всего тестов:     15
Успешно:          12
Провалено:        3
Процент успеха:   80%

Проваленные тесты:
  ❌ Service: GitLab
     Connection timed out
```

**Критерии прохождения**:
- ✅ Процент успеха ≥ 80% → Система готова к работе
- ⚠️  Процент успеха 50-80% → Требуется доработка
- ❌ Процент успеха < 50% → Критические проблемы

### Логи тестирования

Результаты сохраняются в:
- `logs/test-report-YYYYMMDD-HHmmss.txt` - итоговый отчет
- `logs/init-projects.log` - логи инициализации проектов
- `logs/load-seed-data.log` - логи загрузки данных

---

## Ручное тестирование

### Создание задачи в Redmine

#### Шаг 1: Создание проекта для тестирования

1. Откройте Redmine: http://localhost:3000
2. Проекты → Создать проект
3. Заполните:
   - **Название**: "Тестирование внешнего отчета"
   - **Идентификатор**: `test-external-report`
   - **Описание**: "Проверка работоспособности внешнего отчета в 1С"
4. Нажмите "Создать"

#### Шаг 2: Создание задачи

1. В проекте нажмите "Новая задача"
2. Заполните:
   - **Трекер**: Задача
   - **Тема**: "Проверка внешнего отчета УТ-103"
   - **Описание**: См. шаблон ниже
   - **Назначена**: developer
   - **Приоритет**: Нормальный
   - **Срок**: +7 дней

**Шаблон описания задачи**:
```markdown
## Цель
Проверить работоспособность внешнего отчета в конфигурации 1С

## Объект тестирования
- Внешний отчет: `external-reports/Report_UT103.erf`
- Изменения конфигурации: версия 1.0.1

## Чеклист проверки
- [ ] Отчет загружается в толстый клиент без ошибок
- [ ] Реквизиты отчета заполнены корректно
- [ ] Печатная форма формируется без ошибок
- [ ] Экспорт в Excel работает
- [ ] Данные в отчете соответствуют ожидаемым

## Тестовые данные
- База: test_ut103.1cd
- Пользователь: Администратор
- Период: 01.11.2025 - 06.11.2025

## Критерии успеха
- Все пункты чеклиста выполнены
- Нет критичных ошибок
- Производительность приемлема (< 5 сек на формирование)

## Связанные задачи
- GitLab MR: #123
- Redmine Task: #456
```

### Проверка внешнего отчета

#### Подготовка

1. **Создание внешнего отчета** (если еще не создан):

```powershell
# Создание структуры
New-Item -ItemType Directory -Path "workspace/external-reports" -Force

# Создание примера отчета (заглушка)
$reportContent = @"
<?xml version="1.0" encoding="UTF-8"?>
<MetaDataObject xmlns="http://v8.1c.ru/8.3/MDClasses">
    <ExternalReport uuid="12345678-1234-1234-1234-123456789012">
        <Properties>
            <Name>Report_UT103</Name>
            <Synonym>
                <v8:item>
                    <v8:lang>ru</v8:lang>
                    <v8:content>Отчет УТ-103</v8:content>
                </v8:item>
            </Synonym>
        </Properties>
    </ExternalReport>
</MetaDataObject>
"@

Set-Content -Path "workspace/external-reports/Report_UT103.xml" -Value $reportContent -Encoding UTF8
```

2. **Разборка отчета через GitSync** (если нужно):

```powershell
# Запуск GitSync для разборки
.\gitsync-run.ps1
```

#### Тестирование в 1С

**Чеклист ручной проверки**:

- [ ] **Загрузка отчета**
  1. Запустите 1С в режиме "Толстый клиент"
  2. Меню: Файл → Открыть
  3. Выберите `external-reports/Report_UT103.erf`
  4. **Ожидается**: Отчет открывается без ошибок

- [ ] **Проверка реквизитов**
  1. В открытом отчете: Действия → Настройки
  2. Проверьте наличие полей:
     - Период (Дата начала, Дата окончания)
     - Организация (Справочник)
     - Детализация (Перечисление)
  3. **Ожидается**: Все реквизиты на месте, типы корректны

- [ ] **Формирование отчета**
  1. Заполните параметры:
     - Период: 01.11.2025 - 06.11.2025
     - Организация: (любая из справочника)
  2. Нажмите "Сформировать"
  3. **Ожидается**: 
     - Отчет формируется за < 5 секунд
     - Нет ошибок выполнения
     - Данные отображаются корректно

- [ ] **Печатная форма**
  1. В сформированном отчете: Файл → Печать → Печать
  2. **Ожидается**: 
     - Печатная форма открывается
     - Форматирование корректное
     - Все данные присутствуют

- [ ] **Экспорт**
  1. В отчете: Файл → Сохранить как → Excel
  2. Сохраните файл
  3. Откройте в Excel
  4. **Ожидается**:
     - Файл открывается без ошибок
     - Структура сохранена
     - Данные читаемы

- [ ] **Регрессия**
  1. Выполните базовые операции:
     - Создание документа
     - Проведение документа
     - Формирование отчета повторно
  2. **Ожидается**:
     - Новые данные появились в отчете
     - Старые данные сохранены
     - Нет конфликтов

### Проверка изменений конфигурации

#### Чеклист проверки конфигурации

- [ ] **Сборка конфигурации**
  1. Откройте конфигурацию в Конфигураторе
  2. Конфигурация → Открыть конфигурацию
  3. **Ожидается**: Конфигурация открывается без ошибок

- [ ] **Синтаксическая проверка**
  1. Конфигурация → Проверить конфигурацию
  2. **Ожидается**: 
     - Нет критичных ошибок
     - Предупреждения (если есть) документированы

- [ ] **Обновление базы**
  1. Создайте тестовую базу
  2. Конфигурация → Обновить конфигурацию БД
  3. **Ожидается**:
     - Обновление проходит успешно
     - Нет ошибок при обновлении
     - База запускается

- [ ] **Права доступа**
  1. Администрирование → Пользователи
  2. Проверьте роли:
     - Администратор
     - Разработчик
     - Пользователь
  3. **Ожидается**: Все роли на месте, права назначены корректно

- [ ] **Интеграции**
  1. Проверьте внешние соединения (если есть)
  2. Проверьте веб-сервисы (если есть)
  3. **Ожидается**: Все интеграции функционируют

### Документирование результатов

После завершения тестирования обновите задачу в Redmine:

1. Заполните чеклист (отметьте галочками)
2. Добавьте комментарий с результатами:

```markdown
## Результаты тестирования

**Дата**: 06.11.2025
**Тестировщик**: [Ваше имя]
**Конфигурация**: 1С:УТ 11.4.6
**База**: test_ut103.1cd

### Общий результат
✅ Все тесты пройдены успешно

### Детали
- ✅ Внешний отчет загружается корректно
- ✅ Реквизиты заполнены
- ✅ Формирование отчета: 2.3 секунды
- ✅ Печатная форма работает
- ✅ Экспорт в Excel без ошибок

### Найденные проблемы
- ⚠️  Предупреждение о устаревшем методе в модуле отчета (строка 123)
  Рекомендация: обновить на новый синтаксис

### Скриншоты
[Приложите скриншоты]

### Рекомендация
✅ Готово к выпуску в продуктив
```

3. Измените статус задачи на "Решена"
4. Назначьте на аналитика для финального одобрения

---

## Чеклисты проверки

### Чеклист первоначального заполнения

- [ ] Docker контейнеры запущены
- [ ] GitLab доступен и настроен
- [ ] Redmine доступен и настроен
- [ ] SonarQube доступен и настроен
- [ ] PostgreSQL работает стабильно
- [ ] Токены доступа созданы и сохранены
- [ ] Файл .env заполнен корректно
- [ ] Проекты созданы во всех системах
- [ ] Webhooks настроены
- [ ] GitLab Runner зарегистрирован
- [ ] Пользователи загружены
- [ ] Эталонные данные загружены
- [ ] Контрольные суммы проверены

### Чеклист автоматизированного тестирования

- [ ] PreCommit1C: OneScript установлен
- [ ] PreCommit1C: Синтаксис проверен
- [ ] Unit Tests: Структура тестов создана
- [ ] Unit Tests: Python тесты выполнены
- [ ] SonarQube: Scanner установлен
- [ ] SonarQube: Конфигурация создана
- [ ] SonarQube: Проект готов к анализу
- [ ] Functional: GitLab доступен
- [ ] Functional: Redmine доступен
- [ ] Functional: SonarQube доступен
- [ ] Functional: PostgreSQL доступен
- [ ] Functional: GitSync логи чистые
- [ ] Отчет тестирования создан

### Чеклист ручного тестирования

- [ ] Задача в Redmine создана
- [ ] Внешний отчет подготовлен
- [ ] Отчет загружается в 1С
- [ ] Реквизиты корректны
- [ ] Отчет формируется успешно
- [ ] Печатная форма работает
- [ ] Экспорт в Excel работает
- [ ] Конфигурация собирается
- [ ] Синтаксис проверен
- [ ] База обновляется
- [ ] Права доступа корректны
- [ ] Регрессия пройдена
- [ ] Результаты задокументированы
- [ ] Задача закрыта

---

## Решение проблем

### Проблема: GitLab недоступен

**Симптомы**:
```
❌ Service: GitLab
   Connection timed out
```

**Решение**:
```powershell
# Проверка контейнера
docker ps | grep gitlab

# Проверка логов
docker logs gitlab

# Перезапуск
docker restart gitlab

# Ожидание инициализации (может занять до 5 минут)
Start-Sleep -Seconds 300
```

### Проблема: Redmine API недоступен

**Симптомы**:
```
❌ Ошибка создания проекта 'UT-103 CI/CD': 401 Unauthorized
```

**Решение**:
1. Проверьте API key в Redmine UI
2. Убедитесь что REST API включен:
   - Администрирование → Настройки → API
   - ✅ Включить REST API
3. Обновите `REDMINE_API_KEY` в `.env`

### Проблема: SonarQube требует смены пароля

**Симптомы**:
```
401 Unauthorized
```

**Решение**:
1. Откройте http://localhost:9000
2. Войдите как `admin` / `admin`
3. Следуйте инструкциям по смене пароля
4. Создайте новый токен
5. Обновите `SONARQUBE_TOKEN` в `.env`

### Проблема: GitSync падает с ошибкой

**Симптомы**:
```
ERROR: Не задан путь к платформе 1С
```

**Решение**:
```powershell
# Проверка gitsync.json
Get-Content workspace/gitsync.json

# Убедитесь что путь к платформе корректный
# Для Windows должен быть:
"v8version": "C:/Program Files/1cv8/8.3.12.1714/bin"

# Для гибридной системы (на хосте):
"v8version": "C:\\Program Files\\1cv8\\8.3.12.1714\\bin"
```

### Проблема: Тесты не находят модули

**Симптомы**:
```
⚠️  Модули для проверки не найдены
```

**Решение**:
```powershell
# Запустите GitSync для разборки конфигурации
.\gitsync-run.ps1

# Проверьте наличие модулей
Get-ChildItem -Path workspace -Recurse -Include "*.bsl","*.os"

# Если модулей нет, проверьте хранилище 1С
Test-Path "C:\1crepository"
```

---

## Контакты

**Автор**: Бостанов Ф.А.  
**Email**: ci@1c-cicd.local  
**Репозиторий**: https://github.com/bostanov/cicdut103

---

**Версия документа**: 1.0  
**Последнее обновление**: 6 ноября 2025


stages:
  - sync
  - dump-externals
  - lint-bsl
  - lint-externals
  - build-compile
  - sonar
  - quality-gate
  - package
  - notify

variables:
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: none

# Sync from 1C repository
sync:
  stage: sync
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "sync"'
    - when: manual
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/export-from-storage.ps1 -Config ci/config/ci-settings.json
  artifacts:
    paths:
      - config-src/
    expire_in: 1 day

# Dump external reports/data processors
dump-externals:
  stage: dump-externals
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "dump-externals"'
      when: manual
    - when: always
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/dump-externals.ps1
  artifacts:
    paths:
      - externals-src/
    expire_in: 1 day
  allow_failure: true

# Lint BSL code
lint-bsl:
  stage: lint-bsl
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "lint-bsl"'
      when: manual
    - when: always
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/lint-bsl.ps1
  artifacts:
    reports:
      junit: build/reports/*.xml
    expire_in: 7 days
  allow_failure: true

# Lint external files
lint-externals:
  stage: lint-externals
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "lint-externals"'
    - when: always
  needs:
    - dump-externals
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/lint-bsl.ps1 -Source externals-src
  artifacts:
    reports:
      junit: build/reports/*.xml
    expire_in: 7 days

# Build and compile configuration
build-compile:
  stage: build-compile
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "build-compile"'
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: always
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/build-compile.ps1
  artifacts:
    paths:
      - build/compile/*.log
    when: always
    expire_in: 7 days
  allow_failure: true

# SonarQube analysis
sonar:
  stage: sonar
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "sonar"'
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: always
  script:
    - C:\Tools\sonar-scanner\bin\sonar-scanner.bat -Dsonar.projectBaseDir=$CI_PROJECT_DIR
  artifacts:
    paths:
      - .scannerwork/
    expire_in: 1 day
  allow_failure: true

# Quality Gate check
quality-gate:
  stage: quality-gate
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "quality-gate"'
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: always
  needs:
    - sonar
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/quality-gate.ps1
  allow_failure: true

# Package artifacts
package:
  stage: package
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "package"'
    - when: manual
  script:
    - echo "Package configuration"
  artifacts:
    paths:
      - build/package/
    expire_in: 30 days

# Notify Redmine
notify:
  stage: notify
  tags:
    - windows
    - 1c
  rules:
    - when: always
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/notify-redmine.ps1
  allow_failure: true


# Test Runner execution
test-runner:
  stage: test
  tags:
    - windows
    - 1c
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/test-runner.ps1
  when: always
  allow_failure: true

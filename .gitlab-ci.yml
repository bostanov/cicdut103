stages:
  - sync
  - dump-externals
  - build-compile
  - package
  - notify

variables:
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: none

# Sync 1C configuration to dedicated repository
sync:
  stage: sync
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "sync"'
    - when: manual
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/sync-1c-configuration.ps1
  allow_failure: true

# Dump external reports/data processors
dump-externals:
  stage: dump-externals
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "dump-externals"'
      when: manual
    - when: always
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/dump-externals.ps1
  artifacts:
    paths:
      - externals-src/
    expire_in: 1 day
  allow_failure: true


# Build and compile configuration
build-compile:
  stage: build-compile
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "build-compile"'
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: always
    - when: always
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/build-compile.ps1
  artifacts:
    paths:
      - build/compile/*.log
    when: always
    expire_in: 7 days
  allow_failure: true


# Package artifacts
package:
  stage: package
  tags:
    - windows
    - 1c
  rules:
    - if: '$RUN_SCRIPT == "package"'
    - when: manual
  script:
    - echo "Package configuration"
  artifacts:
    paths:
      - build/package/
    expire_in: 30 days

# Notify Redmine
notify:
  stage: notify
  tags:
    - windows
    - 1c
  rules:
    - when: always
  script:
    - powershell -ExecutionPolicy Bypass -File ci/scripts/notify-redmine.ps1
  allow_failure: true

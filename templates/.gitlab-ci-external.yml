# GitLab CI/CD Pipeline для внешних файлов 1С (ut103-external-files)

stages:
  - parse
  - analyze
  - report

variables:
  SONARQUBE_URL: "${SONARQUBE_URL}"
  SONARQUBE_TOKEN: "${SONARQUBE_TOKEN}"
  REDMINE_URL: "${REDMINE_URL}"
  REDMINE_API_KEY: "${REDMINE_API_KEY}"
  PROJECT_KEY: "ut103-external-files"

# Разбор внешних файлов
parse:
  stage: parse
  script:
    - echo "Проверка разобранных файлов..."
    - find . -name "*.bsl" -o -name "*.os"
    - echo "Файлы найдены"
  artifacts:
    paths:
      - "**/*.bsl"
      - "**/*.os"
    expire_in: 1 hour
  only:
    - main
    - /^issue\/.*$/

# Анализ качества кода
analyze:
  stage: analyze
  image: sonarsource/sonar-scanner-cli:latest
  script:
    - echo "Запуск анализа SonarQube для внешних файлов..."
    - |
      sonar-scanner \
        -Dsonar.projectKey=${PROJECT_KEY} \
        -Dsonar.sources=. \
        -Dsonar.inclusions="**/*.bsl,**/*.os" \
        -Dsonar.host.url=${SONARQUBE_URL} \
        -Dsonar.login=${SONARQUBE_TOKEN}
    - echo "Анализ завершен"
  dependencies:
    - parse
  allow_failure: false
  only:
    - main
    - /^issue\/.*$/

# Отчет в Redmine
report:
  stage: report
  script:
    - echo "Формирование отчета для Redmine..."
    - |
      ISSUE_ID=$(echo $CI_COMMIT_REF_NAME | grep -oP 'issue/\K\d+')
      if [ ! -z "$ISSUE_ID" ]; then
        # Получение результатов из SonarQube
        QUALITY_GATE=$(curl -s "${SONARQUBE_URL}/api/qualitygates/project_status?projectKey=${PROJECT_KEY}" \
          -H "Authorization: Bearer ${SONARQUBE_TOKEN}" | jq -r '.projectStatus.status')
        
        # Отправка в Redmine
        curl -X PUT "${REDMINE_URL}/issues/${ISSUE_ID}.json" \
          -H "X-Redmine-API-Key: ${REDMINE_API_KEY}" \
          -H "Content-Type: application/json" \
          -d "{\"issue\":{\"notes\":\"Анализ завершен. Quality Gate: ${QUALITY_GATE}. Pipeline: ${CI_PIPELINE_URL}\"}}"
      fi
  when: always
  only:
    - main
    - /^issue\/.*$/

stages:
  - validate
  - analyze
  - notify

variables:
  SONARQUBE_URL: "http://sonarqube:9000"
  SONARQUBE_TOKEN: "admin"
  REDMINE_URL: "http://redmine:3000"
  REDMINE_API_KEY: "d20441c1b3666d9305adf9116834f5c7e6bfb947"

# –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã 1–° –ø—Ä–æ–µ–∫—Ç–∞
validate_1c_structure:
  stage: validate
  image: ubuntu:22.04
  script:
    - echo "üîç Validating 1C project structure..."
    - |
      if [ -f "Configuration.xml" ]; then
        echo "‚úÖ Configuration.xml found"
      else
        echo "‚ùå Configuration.xml not found"
        exit 1
      fi
    - |
      if [ -f "VERSION" ]; then
        echo "‚úÖ VERSION file found"
        echo "üìã Version: $(cat VERSION)"
      else
        echo "‚ùå VERSION file not found"
        exit 1
      fi
    - echo "‚úÖ 1C project structure validation completed"
  artifacts:
    reports:
      junit: validation-report.xml
    expire_in: 1 hour
  only:
    - master
    - merge_requests

# –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –≤ SonarQube
sonarqube_analysis:
  stage: analyze
  image: sonarsource/sonar-scanner-cli:latest
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - echo "üîç Starting SonarQube analysis..."
    - |
      sonar-scanner \
        -Dsonar.projectKey=ut103-ci \
        -Dsonar.projectName="1C UT 10.3 Main Project" \
        -Dsonar.projectVersion=$(cat VERSION | grep -o '[0-9]*' | head -1 || echo "1") \
        -Dsonar.sources=. \
        -Dsonar.exclusions="**/*.xml,**/*.json,**/dumplist.txt" \
        -Dsonar.host.url=$SONARQUBE_URL \
        -Dsonar.login=$SONARQUBE_TOKEN \
        -Dsonar.qualitygate.wait=true \
        -Dsonar.qualitygate.timeout=300
    - echo "‚úÖ SonarQube analysis completed"
  dependencies:
    - validate_1c_structure
  only:
    - master
    - merge_requests
  allow_failure: true

# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Redmine
notify_redmine:
  stage: notify
  image: curlimages/curl:latest
  script:
    - echo "üì¢ Sending notification to Redmine..."
    - |
      PIPELINE_STATUS="success"
      if [ "$CI_JOB_STATUS" = "failed" ]; then
        PIPELINE_STATUS="failed"
      fi
    - |
      COMMIT_MESSAGE=$(echo "$CI_COMMIT_MESSAGE" | head -1)
      NOTIFICATION_TEXT="üöÄ CI/CD Pipeline completed for commit $CI_COMMIT_SHORT_SHA

      üìã **Pipeline Details:**
      - Status: $PIPELINE_STATUS
      - Branch: $CI_COMMIT_REF_NAME
      - Commit: $COMMIT_MESSAGE
      - Pipeline URL: $CI_PIPELINE_URL
      - SonarQube: $SONARQUBE_URL/dashboard?id=ut103-ci

      üîç **Analysis Results:**
      - 1C Structure: Validated
      - Code Quality: Analyzed in SonarQube
      - Timestamp: $(date)
      "
    - |
      curl -X POST \
        -H "X-Redmine-API-Key: $REDMINE_API_KEY" \
        -H "Content-Type: application/json" \
        -d "{
          \"issue\": {
            \"project_id\": 2,
            \"tracker_id\": 1,
            \"status_id\": 1,
            \"priority_id\": 2,
            \"subject\": \"CI/CD Pipeline: $CI_COMMIT_SHORT_SHA - $PIPELINE_STATUS\",
            \"description\": \"$NOTIFICATION_TEXT\"
          }
        }" \
        "$REDMINE_URL/issues.json" || echo "‚ö†Ô∏è Failed to create Redmine issue"
    - echo "‚úÖ Redmine notification completed"
  dependencies:
    - validate_1c_structure
    - sonarqube_analysis
  when: always
  only:
    - master
    - merge_requests

# –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
cleanup:
  stage: notify
  image: alpine:latest
  script:
    - echo "üßπ Cleaning up temporary files..."
    - rm -rf .sonar || true
    - echo "‚úÖ Cleanup completed"
  when: always
  only:
    - master
    - merge_requests
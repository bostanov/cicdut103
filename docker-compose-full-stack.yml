# Docker Compose файл для полного стека CI/CD системы

services:
  # Используем существующий PostgreSQL контейнер
  # postgres: используется внешний контейнер postgres_unified

  # GitLab - Git репозиторий и CI/CD пайплайны
  gitlab:
    image: gitlab/gitlab-ce:16.11.10-ce.0
    container_name: gitlab-cicd
    restart: unless-stopped
    hostname: 'gitlab.local'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://gitlab.local'
        gitlab_rails['gitlab_shell_ssh_port'] = 8022
        gitlab_rails['initial_root_password'] = 'gitlab_root_password'
        
        # Подключение к внешнему PostgreSQL
        gitlab_rails['db_adapter'] = 'postgresql'
        gitlab_rails['db_encoding'] = 'utf8'
        gitlab_rails['db_host'] = 'postgres_cicd'
        gitlab_rails['db_port'] = 5432
        gitlab_rails['db_database'] = 'gitlab'
        gitlab_rails['db_username'] = 'gitlab'
        gitlab_rails['db_password'] = 'gitlab_password_123'
        
        # Отключение встроенного PostgreSQL
        postgresql['enable'] = false
        
        # Оптимизация ресурсов
        prometheus_monitoring['enable'] = false
        grafana['enable'] = false
        
        # Настройка CI/CD
        gitlab_rails['gitlab_default_projects_features_builds'] = true
        gitlab_rails['gitlab_default_projects_features_container_registry'] = false
        
        # Настройка автоматической регистрации runner'ов
        gitlab_rails['gitlab_shell_git_timeout'] = 800
    ports:
      - "8929:80"
      - "8443:443" 
      - "8022:22"
    volumes:
      - gitlab_config:/etc/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_data:/var/opt/gitlab
    networks:
      - cicd-network
    # depends_on: используется внешний PostgreSQL контейнер
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/-/health || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 10
      start_period: 600s
    shm_size: '256m'

  # Redmine - управление задачами и внешними файлами
  redmine:
    image: redmine:latest
    container_name: redmine-cicd
    restart: unless-stopped
    environment:
      REDMINE_DB_POSTGRES: "postgres_cicd"
      REDMINE_DB_HOST: "postgres_cicd"
      REDMINE_DB_PORT: "5432"
      REDMINE_DB_DATABASE: "redmine"
      REDMINE_DB_USERNAME: "redmine"
      REDMINE_DB_PASSWORD: "redmine_password_123"
      REDMINE_SECRET_KEY_BASE: "redmine_secret_key_base_12345678901234567890"
      
      # Настройки для интеграции
      REDMINE_PLUGINS_MIGRATE: "true"
      REDMINE_NO_DB_MIGRATE: "false"
    ports:
      - "3000:3000"
    volumes:
      - redmine_data:/usr/src/redmine/files
      - redmine_logs:/usr/src/redmine/log
      - redmine_plugins:/usr/src/redmine/plugins
    networks:
      - cicd-network
    # depends_on: используется внешний PostgreSQL контейнер
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 300s

  # SonarQube - анализ качества кода
  sonarqube:
    image: sonarqube:community
    container_name: sonarqube-cicd
    restart: unless-stopped
    environment:
      # Подключение к внешнему PostgreSQL
      SONAR_JDBC_URL: jdbc:postgresql://postgres_cicd:5432/sonarqube
      SONAR_JDBC_USERNAME: sonarqube
      SONAR_JDBC_PASSWORD: sonarqube_password_123
      
      # Настройки производительности
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
      SONAR_WEB_JAVAADDITIONALOPTS: "-Xmx1024m -Xms256m"
      SONAR_CE_JAVAADDITIONALOPTS: "-Xmx1024m -Xms256m"
      
      # Настройки для интеграции
      SONAR_FORCEAUTHENTICATION: "false"
    ports:
      - "9000:9000"
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_logs:/opt/sonarqube/logs
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_temp:/opt/sonarqube/temp
    networks:
      - cicd-network
    # depends_on: используется внешний PostgreSQL контейнер
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/api/system/status || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 10
      start_period: 600s
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536

  # CI/CD Service - объединенный контейнер с GitSync и PreCommit1C
  cicd-service:
    build:
      context: ./docker/ci-cd
      dockerfile: Dockerfile
    container_name: cicd-service-final
    restart: unless-stopped
    environment:
      # PostgreSQL подключение к существующему контейнеру
      POSTGRES_HOST: postgres_cicd
      POSTGRES_PORT: 5432
      POSTGRES_DB: cicd
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres_admin_123
      
      # GitSync настройки
      GITSYNC_STORAGE_PATH: file:///1c-storage
      GITSYNC_STORAGE_USER: gitsync
      GITSYNC_STORAGE_PASSWORD: "123"
      GITSYNC_SYNC_INTERVAL: 600  # 10 минут
      
      # GitLab интеграция
      GITLAB_URL: http://gitlab
      GITLAB_TOKEN: "YOUR_GITLAB_TOKEN_HERE"
      GITLAB_PROJECT_ID: "1"
      
      # Redmine интеграция
      REDMINE_URL: http://redmine:3000
      REDMINE_USERNAME: admin
      REDMINE_PASSWORD: admin
      REDMINE_PROJECT_ID: ut103-ci
      CHECK_INTERVAL: 300  # 5 минут
      
      # SonarQube интеграция
      SONARQUBE_URL: http://sonarqube:9000
      SONARQUBE_TOKEN: "YOUR_SONARQUBE_TOKEN_HERE"
      SONARQUBE_PROJECT_KEY: ut103-ci
      
      # Общие настройки
      LOG_LEVEL: INFO
      WORKSPACE_PATH: /workspace
      EXTERNAL_FILES_PATH: /workspace/external-files
      
      # Настройки автоинициализации
      AUTO_INIT_SERVICES: "false"
      WAIT_FOR_SERVICES: "false"
      INIT_TIMEOUT: 1800  # 30 минут
      
    volumes:
      # Хранилище 1С (read-write для lock-файлов) - настройте путь к вашему хранилищу
      - C:/1crepository:/1c-storage
      # Рабочая директория
      - cicd_workspace:/workspace
      # Логи
      - cicd_logs:/logs
      # Временные файлы
      - cicd_temp:/tmp/1c
      
    ports:
      - "8085:8085"  # Health check endpoint
      - "8090:8090"  # API endpoint
      
    networks:
      - cicd-network
      
    # depends_on: используется внешний PostgreSQL и другие сервисы
    external_links:
      - postgres_cicd:postgres
        
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8085/health || exit 1"]
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 300s

volumes:
  # GitLab volumes
  gitlab_config:
    driver: local
  gitlab_logs:
    driver: local
  gitlab_data:
    driver: local
    
  # Redmine volumes
  redmine_data:
    driver: local
  redmine_logs:
    driver: local
  redmine_plugins:
    driver: local
    
  # SonarQube volumes
  sonarqube_data:
    driver: local
  sonarqube_logs:
    driver: local
  sonarqube_extensions:
    driver: local
  sonarqube_temp:
    driver: local
    
  # CI/CD volumes
  cicd_workspace:
    driver: local
  cicd_logs:
    driver: local
  cicd_temp:
    driver: local

networks:
  cicd-network:
    external: true

# Секреты убраны - используются переменные окружения для упрощения
